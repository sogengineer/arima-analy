# 分析モデル詳細

有馬記念分析システムで使用されている予測・分析モデルの詳細です。

## 目次

- [スコアリングモデル](#スコアリングモデル)
- [機械学習モデル](#機械学習モデル)
- [統計ベース予測](#統計ベース予測)
- [最終予想の生成](#最終予想の生成)

---

## スコアリングモデル

7つの評価項目を加重平均して総合スコアを算出するモデルです。

### 実装ファイル

```
src/domain/entities/Horse.ts       # スコア計算ロジック（リッチドメインモデル）
src/domain/entities/Jockey.ts      # 騎手スコア計算
src/domain/services/ScoringOrchestrator.ts  # オーケストレーター
src/commands/CalculateScore.ts     # スコアリングコマンド
src/constants/ScoringConstants.ts  # 定数定義
```

### スコア構成

| 評価項目 | 重み | 説明 |
|---------|------|------|
| 直近成績スコア | 25% | 直近5戦の着順・人気・オッズを評価 |
| コース適性 | 18% | 会場（中山等）での過去成績 |
| 距離適性 | 15% | 目標距離±300mでの成績 |
| 騎手能力 | 15% | 会場成績・G1成績・調教師とのコンビ成績 |
| ローテ適性 | 15% | 出走間隔と成績の関係 |
| 上がり3F能力 | 7% | レース終盤での差し・追い込み能力 |
| G1実績 | 5% | G1レースでの入賞実績 |

### 計算式

```
総合スコア = (直近成績 × 0.25) + (コース適性 × 0.18) + (距離適性 × 0.15) +
             (騎手能力 × 0.15) + (ローテ × 0.15) + (上がり3F × 0.07) + (G1実績 × 0.05)
```

---

### 1. 直近成績スコア（25%）

直近5戦の成績を新しいレースほど重視して評価します。

#### 重みづけ

| 順番 | 重み |
|------|------|
| 直近1戦目 | 40% |
| 直近2戦目 | 25% |
| 直近3戦目 | 20% |
| 直近4戦目 | 10% |
| 直近5戦目 | 5% |

#### 着順による得点

| 着順 | 基本点 |
|------|-------|
| 1着 | 100点 |
| 2着 | 70点 |
| 3着 | 50点 |
| 4着 | 35点 |
| 5着 | 25点 |
| 6着 | 15点 |
| 7着 | 10点 |
| 8着以下 | 5点 |

#### 補正

- **人気を上回る成績**: 着順が人気より良い場合、ボーナス点を加算
  - 例: 5番人気で1着 → +20点

---

### 2. コース適性スコア（18%）

指定会場での過去成績を評価します。

#### 計算方法

```
基本スコア = 会場での勝率 × 100
```

#### 信頼度係数

| 会場での出走数 | 係数 |
|--------------|------|
| 3走以上 | 1.0 |
| 2走 | 0.8 |
| 1走 | 0.6 |
| 0走 | 0.5（デフォルト50点） |

---

### 3. 騎手能力スコア（15%）

騎手の過去成績を4つの観点から評価します。

#### 構成要素

| 要素 | 重み | 説明 |
|------|------|------|
| 会場勝率 | 30% | 指定会場での勝率 |
| 会場G1勝率 | 30% | 指定会場のG1レースでの勝率 |
| 全体勝率 | 20% | 全コースでの勝率 |
| 調教師コンビ勝率 | 20% | 該当馬の調教師とのコンビでの勝率 |

#### 計算式

```
騎手スコア = (会場勝率スコア × 0.30) + (会場G1勝率スコア × 0.30) +
             (全体勝率スコア × 0.20) + (調教師コンビ勝率スコア × 0.20)
```

#### 信頼度補正

| 会場出走数 | 係数 |
|-----------|------|
| 50走以上 | 1.0 |
| 20〜49走 | 0.9 |
| 10〜19走 | 0.8 |
| 10走未満 | 0.6 |

---

### 4. G1実績スコア（13%）

G1レースでの実績を評価します。

#### 得点配分

| 実績 | 得点 |
|------|------|
| G1勝利 | 50点/勝 |
| G1で3着以内 | 25点/回 |
| G1出走 | 5点/回 |

#### 上限

最大100点

---

### 5. 距離適性スコア（12%）

2200m以上の長距離レースでの成績を評価します（有馬記念は2500m）。

#### 計算方法

```
基本スコア = 長距離での複勝率 × 100
```

#### 信頼度係数

| 長距離での出走数 | 係数 |
|----------------|------|
| 5走以上 | 1.0 |
| 3〜4走 | 0.9 |
| 1〜2走 | 0.7 |
| 0走 | 0.5（デフォルト50点） |

---

### 6. 上がり3F能力スコア（12%）

レース終盤での差し・追い込み能力を評価します。

#### 計算方法

```
基本スコア = 2000m以上での3着以内率 × 100
```

上がり3Fタイムが利用可能な場合は、そのタイムも考慮します。

---

### 7. ローテ適性スコア（10%）

出走間隔（ローテーション）と成績の関係を評価します。

#### 最適間隔

3〜12週間の間隔での好走率を評価します。

```
基本スコア = 適切な間隔での複勝率 × 100
```

---

## 機械学習モデル

ロジスティック回帰とランダムフォレストを組み合わせたアンサンブル予測モデルです。

### 実装ファイル

```
src/models/MachineLearningModel.ts
```

### アルゴリズム構成

| アルゴリズム | 重み | 説明 |
|-------------|------|------|
| ロジスティック回帰 | 30% | 確率ベースの予測 |
| ランダムフォレスト | 70% | 特徴量の非線形関係を学習 |

### 特徴量（10次元）

| # | 特徴量 | 説明 | 範囲 |
|---|--------|------|------|
| 1 | last3RacesDeviation | 過去3走の偏差値 | 0〜100 |
| 2 | lastRacePosition | 前走着順 | 1〜18 |
| 3 | lastRaceTimeDiff | 前走タイム差（秒） | -10〜10 |
| 4 | venuePlaceRate | 会場別複勝率 | 0〜1 |
| 5 | jockeyVenueG1WinRate | 騎手の会場別G1勝率 | 0〜1 |
| 6 | age | 馬齢 | 2〜10 |
| 7 | sexNumeric | 性別（牡=1, 牝=0, 騸=0.5） | 0〜1 |
| 8 | totalRuns | 通算出走数 | 0〜100 |
| 9 | winRate | 勝率 | 0〜1 |
| 10 | avgFinishPosition | 平均着順 | 1〜18 |

---

### ロジスティック回帰

#### パラメータ

| パラメータ | 値 |
|-----------|-----|
| イテレーション | 1000 |
| 学習率 | 0.1 |
| 正則化 | なし |

#### 予測対象

- 複勝圏内（3着以内）かどうかの二値分類

---

### ランダムフォレスト

#### パラメータ

| パラメータ | 値 |
|-----------|-----|
| 決定木の数 | 100 |
| 最大深度 | なし（制限なし） |
| 最小サンプル数 | 2 |

#### 予測対象

- 複勝確率（0〜1の連続値）

---

### アンサンブル予測

ロジスティック回帰とランダムフォレストの予測結果を重み付けで統合します。

```
最終予測 = (ロジスティック回帰 × 0.3) + (ランダムフォレスト × 0.7)
```

---

### モデル評価

クロスバリデーション（5-fold）で以下の指標を評価します：

| 指標 | 説明 |
|------|------|
| Accuracy | 正解率 |
| Precision | 適合率（予測した複勝のうち実際に複勝した割合） |
| Recall | 再現率（実際の複勝のうち予測できた割合） |
| F1 Score | PrecisionとRecallの調和平均 |
| AUC | ROC曲線下面積 |

---

## 統計ベース予測

シンプルな過去戦績ベースの確率計算モデルです（旧版）。

### 実装ファイル

```
src/commands/PredictCommand.ts
```

### 計算方法

```
勝率 = 勝利数 / 出走数
連対率 = (勝利数 + 2着数) / 出走数
複勝率 = (勝利数 + 2着数 + 3着数) / 出走数
```

### 実績数による調整

出走数が少ない馬は、過信を防ぐために控えめに調整します。

| 出走数 | 調整 |
|--------|------|
| 6走以上 | 調整なし（100%反映） |
| 5走以下 | 70%反映 + 30%デフォルト値 |

### 上限設定

| 確率 | 上限 |
|------|------|
| 勝率 | 50% |
| 連対率 | 70% |
| 複勝率 | 85% |

---

## 最終予想の生成

スコアリングモデルと機械学習モデルの結果を総合して、最終予想を生成します。

### 予想出力形式

```
最終予想（スコアリング × ML総合判断）

◎ 本命: 12番 クリオロゴールド
○ 対抗: 11番 ツルノマイハシ
▲ 単穴: 13番 シャインフォーミー

スコア×ML比較表
予想理由（両モデルの観点から）
穴馬候補
懸念点
買い目提案
```

### 本命・対抗・単穴の選定基準

| 印 | 選定基準 |
|----|---------|
| ◎ 本命 | スコアリング1位かつML予測上位 |
| ○ 対抗 | スコアリング2-3位かつML予測上位 |
| ▲ 単穴 | スコアリングまたはMLで高評価だが片方のみ |

### 穴馬候補の選定

- 人気（オッズ）が低いが、スコアまたはML予測が高い馬
- 勝率は低いが連対率・複勝率が高い馬

### 買い目提案

| 馬券種 | 提案基準 |
|--------|---------|
| 単勝 | 本命馬 |
| 馬連 | 本命×対抗 |
| 3連複 | 本命×対抗×単穴 |
| ワイド | 本命-対抗、本命-単穴、対抗-単穴 |

---

## 関連ファイル

| ファイル | 説明 |
|---------|------|
| `src/domain/entities/Horse.ts` | 馬エンティティ（スコア計算内包） |
| `src/domain/entities/Jockey.ts` | 騎手エンティティ（騎手スコア計算） |
| `src/domain/services/ScoringOrchestrator.ts` | スコアリングオーケストレーター |
| `src/models/MachineLearningModel.ts` | 機械学習モデル実装 |
| `src/commands/CalculateScore.ts` | スコアリングコマンド |
| `src/commands/Predict.ts` | 統計予測コマンド |
| `src/constants/ScoringConstants.ts` | スコア定数定義 |
| `src/types/RepositoryTypes.ts` | リポジトリ型定義 |
