# 分析モデル詳細

有馬記念分析システムで使用されている予測・分析モデルの詳細です。

## 目次

- [スコアリングモデル](#スコアリングモデル)
- [機械学習モデル](#機械学習モデル)
- [バックテスト](#バックテスト)
- [重み最適化](#重み最適化)
- [統計ベース予測](#統計ベース予測)
- [最終予想の生成](#最終予想の生成)

---

## スコアリングモデル

**10要素**の評価項目を加重平均して総合スコアを算出するモデルです。

> **変更履歴**: 専門家会議（2026/01/03）の議論を経て、7要素→10要素に拡張。
> 騎手15%→8%、上がり3F 7%→10%、馬場適性・枠順・調教師を新規追加。

### 実装ファイル

```
src/domain/entities/Horse.ts       # スコア計算ロジック（リッチドメインモデル）
src/domain/entities/Jockey.ts      # 騎手スコア計算
src/domain/entities/Trainer.ts     # 調教師スコア計算
src/domain/services/ScoringOrchestrator.ts  # オーケストレーター
src/commands/CalculateScore.ts     # スコアリングコマンド
src/constants/ScoringConstants.ts  # 定数定義
```

### スコア構成（10要素）

| カテゴリ | 評価項目 | 重み | 説明 |
|---------|---------|------|------|
| 馬の能力・実績 | 直近成績 | 22% | 直近5戦の着順・人気・オッズを評価 |
| | コース適性 | 15% | 会場（中山等）での過去成績 |
| | 距離適性 | 12% | 目標距離±300mでの成績 |
| | 上がり3F能力 | 10% | レース終盤での差し・追い込み能力（標準化済み） |
| 実績 | G1実績 | 5% | G1レースでの入賞実績 |
| コンディション | ローテ適性 | 10% | 出走間隔と成績の関係 |
| | 馬場適性 | 5% | 馬場状態（良/稍重/重/不良）別の成績 |
| 人的要因 | 騎手能力 | 8% | 会場成績・G1成績・調教師コンビ成績 |
| | 調教師 | 8% | G1/重賞での厩舎実績（信頼度補正あり） |
| 枠順 | 枠順効果 | 5% | 中山2500m内枠有利の補正 |

**合計: 100%**

### 計算式

```
総合スコア =
    (直近成績 × 0.22) +
    (コース適性 × 0.15) +
    (距離適性 × 0.12) +
    (上がり3F × 0.10) +
    (G1実績 × 0.05) +
    (ローテ × 0.10) +
    (馬場適性 × 0.05) +
    (騎手能力 × 0.08) +
    (調教師 × 0.08) +
    (枠順効果 × 0.05)
```

---

### 1. 直近成績スコア（22%）

直近5戦の成績を新しいレースほど重視して評価します。

#### 重みづけ

| 順番 | 重み |
|------|------|
| 直近1戦目 | 35% |
| 直近2戦目 | 25% |
| 直近3戦目 | 20% |
| 直近4戦目 | 12% |
| 直近5戦目 | 8% |

#### 着順による得点

| 着順 | 基本点 |
|------|-------|
| 1着 | 100点 |
| 2着 | 80点 |
| 3着 | 65点 |
| 4着 | 45点 |
| 5着 | 45点 |
| 6着 | 25点 |
| 7着 | 25点 |
| 8着 | 25点 |
| 9着以下 | 10点 |

#### 補正

- **人気を上回る成績**: 着順が人気より良い場合、ボーナス点を加算
  - 例: 5番人気で1着 → +20点

---

### 2. コース適性スコア（15%）

指定会場での過去成績を評価します。

#### 計算方法

```
基本スコア = 会場での勝率 × 100
```

#### 信頼度係数

| 会場での出走数 | 係数 |
|--------------|------|
| 3走以上 | 1.0 |
| 2走 | 0.8 |
| 1走 | 0.6 |
| 0走 | 0.5（デフォルト50点） |

---

### 3. 騎手能力スコア（8%）

騎手の過去成績を4つの観点から評価します。

#### 構成要素

| 要素 | 重み | 説明 |
|------|------|------|
| 会場勝率 | 30% | 指定会場での勝率 |
| 会場G1勝率 | 30% | 指定会場のG1レースでの勝率 |
| 全体勝率 | 20% | 全コースでの勝率 |
| 調教師コンビ勝率 | 20% | 該当馬の調教師とのコンビでの勝率 |

#### 計算式

```
騎手スコア = (会場勝率スコア × 0.30) + (会場G1勝率スコア × 0.30) +
             (全体勝率スコア × 0.20) + (調教師コンビ勝率スコア × 0.20)
```

#### 信頼度補正

| 会場出走数 | 係数 |
|-----------|------|
| 50走以上 | 1.0 |
| 20〜49走 | 0.9 |
| 10〜19走 | 0.8 |
| 10走未満 | 0.6 |

---

### 4. G1実績スコア（5%）

G1レースでの実績を評価します。

#### 着順別得点

| 着順 | 得点 |
|------|------|
| G1で1着 | 40点 |
| G1で2着 | 25点 |
| G1で3着 | 18点 |
| G1で4着 | 10点 |
| G1で5着 | 10点 |
| G1で6着以下 | 3点 |

#### デフォルト値

G1実績がない場合: 30点

---

### 5. 距離適性スコア（12%）

2200m以上の長距離レースでの成績を評価します（有馬記念は2500m）。

#### 計算方法

```
基本スコア = 長距離での複勝率 × 100
```

#### 信頼度係数

| 長距離での出走数 | 係数 |
|----------------|------|
| 5走以上 | 1.0 |
| 3〜4走 | 0.9 |
| 1〜2走 | 0.7 |
| 0走 | 0.5（デフォルト50点） |

---

### 6. 上がり3F能力スコア（10%）

レース終盤での差し・追い込み能力を評価します。

#### 計算方法

```
基本スコア = 2000m以上での3着以内率 × 100
```

上がり3Fタイムが利用可能な場合は、そのタイムも考慮します。

---

### 7. ローテ適性スコア（10%）

出走間隔（ローテーション）と成績の関係を評価します。

#### 最適間隔

3〜12週間の間隔での好走率を評価します。

```
基本スコア = 適切な間隔での複勝率 × 100
```

---

### 8. 馬場適性スコア（5%） ※新規

馬場状態（良/稍重/重/不良）別の成績を評価します。

#### 計算方法

```
基本スコア = 該当馬場での勝率 × 60 + 連対率 × 40
```

#### 信頼度係数

| 該当馬場での出走数 | 係数 |
|------------------|------|
| 3走以上 | 1.0 |
| 2走 | 0.8 |
| 1走 | 0.6 |
| 0走 | 0.5（デフォルト50点） |

---

### 9. 調教師スコア（8%） ※新規

調教師（厩舎）のG1・重賞での実績を評価します。

#### 構成要素

| 要素 | 重み | 説明 |
|------|------|------|
| G1勝率 | 60% | G1レースでの勝率 |
| 重賞勝率 | 40% | G2・G3を含む重賞全体での勝率 |

#### 計算式

```
調教師スコア = (G1勝率スコア × 0.60) + (重賞勝率スコア × 0.40)
```

#### 信頼度補正

| G1出走数 | 係数 |
|---------|------|
| 10走以上 | 1.0 |
| 5〜9走 | 0.9 |
| 5走未満 | 0.7 |

---

### 10. 枠順効果スコア（5%） ※新規

中山2500mでの内枠有利特性を補正します。

#### 枠順別スコア

| 枠番 | スコア | 説明 |
|-----|-------|------|
| 1枠 | 100 | 最有利 |
| 2枠 | 95 | |
| 3枠 | 90 | |
| 4枠 | 85 | |
| 5枠 | 70 | 外枠ゾーン |
| 6枠 | 65 | |
| 7枠 | 60 | |
| 8枠 | 55 | 最不利 |

> **根拠**: 過去20年のデータで内枠（1〜4枠）の勝率は外枠の約1.5倍

---

## 機械学習モデル

ロジスティック回帰とランダムフォレストを組み合わせたアンサンブル予測モデルです。

### 実装ファイル

```
src/models/MachineLearningModel.ts
```

### アルゴリズム構成

| アルゴリズム | 重み | 説明 |
|-------------|------|------|
| ロジスティック回帰 | 30% | 確率ベースの予測 |
| ランダムフォレスト | 70% | 特徴量の非線形関係を学習 |

### 特徴量（10次元）

機械学習モデルはスコアリングモデルと**同一の10要素**を特徴量として使用します。

| # | 特徴量 | 説明 | 範囲 |
|---|--------|------|------|
| 1 | recentPerformanceScore | 直近成績スコア | 0〜100 |
| 2 | venueAptitudeScore | コース適性スコア | 0〜100 |
| 3 | distanceAptitudeScore | 距離適性スコア | 0〜100 |
| 4 | last3FAbilityScore | 上がり3F能力スコア | 0〜100 |
| 5 | g1AchievementScore | G1実績スコア | 0〜100 |
| 6 | rotationAptitudeScore | ローテ適性スコア | 0〜100 |
| 7 | jockeyScore | 騎手能力スコア | 0〜100 |
| 8 | trackConditionScore | 馬場適性スコア | 0〜100 |
| 9 | postPositionScore | 枠順効果スコア | 0〜100 |
| 10 | trainerScore | 調教師スコア | 0〜100 |

> **統合のメリット**: スコアリングとMLが同一の特徴量を使用することで、
> 結果の比較・解釈が容易になり、重みの最適化結果をスコアリングに直接適用できます。

---

### ロジスティック回帰

#### パラメータ

| パラメータ | 値 |
|-----------|-----|
| イテレーション | 1000 |
| 学習率 | 0.1 |
| 正則化 | なし |

#### 予測対象

- 複勝圏内（3着以内）かどうかの二値分類

---

### ランダムフォレスト

#### パラメータ

| パラメータ | 値 |
|-----------|-----|
| 決定木の数 | 100 |
| 最大深度 | なし（制限なし） |
| 最小サンプル数 | 2 |

#### 予測対象

- 複勝確率（0〜1の連続値）

---

### アンサンブル予測

ロジスティック回帰とランダムフォレストの予測結果を重み付けで統合します。

```
最終予測 = (ロジスティック回帰 × 0.3) + (ランダムフォレスト × 0.7)
```

---

### モデル評価

クロスバリデーション（5-fold）で以下の指標を評価します：

| 指標 | 説明 |
|------|------|
| Accuracy | 正解率 |
| Precision | 適合率（予測した複勝のうち実際に複勝した割合） |
| Recall | 再現率（実際の複勝のうち予測できた割合） |
| F1 Score | PrecisionとRecallの調和平均 |
| AUC | ROC曲線下面積 |

---

## バックテスト

過去のレース結果を使用してスコアリングの予測精度を検証します。

### 実装ファイル

```
src/commands/Backtest.ts
```

### 実行方法

```bash
# 重賞のみでバックテスト
yarn start backtest

# 全レース対象
yarn start backtest --all

# 詳細表示
yarn start backtest --verbose

# レース数制限
yarn start backtest --limit 10
```

### 評価指標

| 指標 | 説明 |
|------|------|
| Top1的中率 | スコア1位が実際に1着だった割合 |
| Top3的中率 | スコア上位3頭に実際の1着馬が含まれた割合 |
| Top5的中率 | スコア上位5頭に実際の1着馬が含まれた割合 |
| 順位相関 | スコア順位と実際の着順のSpearman相関係数 |
| 回収率シミュレーション | 単勝・複勝・3連複の仮想回収率 |

### 出力例

```
━━━━ バックテスト結果サマリ ━━━━
検証レース数: 15
Top1的中率: 26.7%（4/15）
Top3適中率: 66.7%
Top5適中率: 86.7%
順位相関: 0.42

回収率シミュレーション
単勝: 78% | 複勝: 92% | 3連複: 145%
```

---

## 重み最適化

Ridge回帰（L2正則化）を使用して、過去データから最適な重み配分を学習します。

### 実装ファイル

```
src/models/MachineLearningModel.ts (optimizeWeights メソッド)
```

### 実行方法

```bash
# 基本実行
yarn start optimize-weights

# 正則化パラメータ調整（デフォルト0.1）
yarn start optimize-weights --lambda 0.05

# 最適化重みをコード形式で出力
yarn start optimize-weights --output
```

### アルゴリズム

1. 過去レース結果から学習データを作成
2. 各馬の10要素スコアと実際の着順を対応付け
3. Ridge回帰で重みを最適化（正則化で過学習を防止）
4. 現行重みとの比較・改善率を表示

### 出力例

```
━━━━ 重み最適化結果 ━━━━
学習データ: 150件

要素           現行   最適   差分
直近成績      22.0%  24.3%  +2.3%
コース適性    15.0%  13.8%  -1.2%
距離適性      12.0%  11.5%  -0.5%
上がり3F      10.0%  12.1%  +2.1%
...

予測精度の改善: +3.2%
```

---

## 統計ベース予測

シンプルな過去戦績ベースの確率計算モデルです（旧版）。

### 実装ファイル

```
src/commands/Predict.ts
```

### 計算方法

```
勝率 = 勝利数 / 出走数
連対率 = (勝利数 + 2着数) / 出走数
複勝率 = (勝利数 + 2着数 + 3着数) / 出走数
```

### 実績数による調整

出走数が少ない馬は、過信を防ぐために控えめに調整します。

| 出走数 | 調整 |
|--------|------|
| 6走以上 | 調整なし（100%反映） |
| 5走以下 | 70%反映 + 30%デフォルト値 |

### 上限設定

| 確率 | 上限 |
|------|------|
| 勝率 | 50% |
| 連対率 | 70% |
| 複勝率 | 85% |

---

## 最終予想の生成

スコアリングモデルと機械学習モデルの結果を総合して、最終予想を生成します。

### 予想出力形式

```
最終予想（スコアリング × ML総合判断）

◎ 本命: 12番 クリオロゴールド
○ 対抗: 11番 ツルノマイハシ
▲ 単穴: 13番 シャインフォーミー

スコア×ML比較表
予想理由（両モデルの観点から）
穴馬候補
懸念点
買い目提案
```

### 本命・対抗・単穴の選定基準

| 印 | 選定基準 |
|----|---------|
| ◎ 本命 | スコアリング1位かつML予測上位 |
| ○ 対抗 | スコアリング2-3位かつML予測上位 |
| ▲ 単穴 | スコアリングまたはMLで高評価だが片方のみ |

### 穴馬候補の選定

- 人気（オッズ）が低いが、スコアまたはML予測が高い馬
- 勝率は低いが連対率・複勝率が高い馬

### 買い目提案

| 馬券種 | 提案基準 |
|--------|---------|
| 単勝 | 本命馬 |
| 馬連 | 本命×対抗 |
| 3連複 | 本命×対抗×単穴 |
| ワイド | 本命-対抗、本命-単穴、対抗-単穴 |

---

## 関連ファイル

| ファイル | 説明 |
|---------|------|
| `src/domain/entities/Horse.ts` | 馬エンティティ（スコア計算内包） |
| `src/domain/entities/Jockey.ts` | 騎手エンティティ（騎手スコア計算） |
| `src/domain/entities/Trainer.ts` | 調教師エンティティ（調教師スコア計算） |
| `src/domain/services/ScoringOrchestrator.ts` | スコアリングオーケストレーター |
| `src/models/MachineLearningModel.ts` | 機械学習モデル・重み最適化実装 |
| `src/commands/CalculateScore.ts` | スコアリングコマンド |
| `src/commands/Backtest.ts` | バックテストコマンド |
| `src/commands/Predict.ts` | 統計予測コマンド |
| `src/constants/ScoringConstants.ts` | スコア定数定義（10要素の重み） |
| `src/types/RepositoryTypes.ts` | リポジトリ型定義 |
