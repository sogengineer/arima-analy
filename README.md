# 有馬記念分析ツール

TypeScriptで実装した有馬記念の馬券分析システムです。競走馬の過去戦績を収集・分析し、統計的手法と機械学習を組み合わせて勝率予測を行います。

## 特徴

- JRA出馬表からの自動データ抽出
- **10要素スコアリングモデル**による総合評価（馬場適性・枠順・調教師を含む）
- ロジスティック回帰＋ランダムフォレストによる機械学習予測
- **バックテスト機能**による予測精度の検証
- **重み最適化**による機械学習ベースの改善提案
- Claude Code 対応の対話型インターフェース
- SQLiteによる戦績データの永続化

---

## クイックスタート

### 環境構築

```bash
# 前提条件: Node.js 18以上, yarn

# 依存パッケージのインストール
yarn install

# ビルド
yarn build
```

### 基本的な使い方

#### 1. データ取得

JRA出馬表URLからデータを取得します。

```bash
# JRAからデータを取得して抽出
yarn fetch-and-extract https://www.jra.go.jp/JRADB/accessD.html?CNAME=pw01sde1012024122206

# データベースにインポート
yarn start import-url data/horse-extracted-data.json
```

#### 2. 予想実行

```bash
# スコアリング分析
yarn start score

# 機械学習予測
yarn start ml
```

---

## Claude Code での使い方（推奨）

Claude Code を使用すると、対話形式で簡単に操作できます。

| スキル | 説明 |
|--------|------|
| `/データ取得` | JRA出馬表URLからデータを取得・抽出 |
| `/レース一覧` | 登録済みレースを一覧表示し、予想を実行 |
| `/スコア計算` | 指定レースのスコアリングを実行 |
| `/馬一覧` | 登録済み馬の一覧を表示 |
| `/血統分析` | 種牡馬別の成績統計を表示 |
| `/コース分析 [会場]` | 会場別コース適性分析（省略時は全会場） |
| `/DBインポート` | 抽出JSONをデータベースに登録 |
| `/ヘルプ` | 使い方を表示 |

### 使用例

```
# JRA出馬表からデータを取得
/データ取得 https://www.jra.go.jp/JRADB/accessD.html?CNAME=pw01sde1012024122206

# 登録済みレースから予想したいレースを選択
/レース一覧
```

---

## 予想モデル

### スコアリングモデル

**10要素**の評価項目を加重平均して総合スコアを算出します。

| カテゴリ | 評価項目 | 重み | 説明 |
|---------|---------|------|------|
| 馬の能力 | 直近成績 | 22% | 直近5戦の着順・人気 |
| | コース適性 | 15% | 会場での過去成績 |
| | 距離適性 | 12% | 目標距離±300mでの成績 |
| | 上がり3F | 10% | 差し・追い込み能力（標準化済み） |
| 実績 | G1実績 | 5% | G1での入賞実績 |
| コンディション | ローテ適性 | 10% | 出走間隔と成績の関係 |
| | 馬場適性 | 5% | 馬場状態別の成績 |
| 人的要因 | 騎手能力 | 8% | 会場成績・G1成績 |
| | 調教師 | 8% | G1/重賞での厩舎実績 |
| 枠順 | 枠順効果 | 5% | 中山2500m内枠有利の補正 |

### 機械学習モデル

ロジスティック回帰（30%）とランダムフォレスト（70%）を組み合わせたアンサンブル予測。スコアリングと同じ**10要素**を特徴量として複勝確率を予測します。

---

## 予想出力例

```
最終予想（スコアリング × ML総合判断）

◎ 本命: 12番 クリオロゴールド
○ 対抗: 11番 ツルノマイハシ
▲ 単穴: 13番 シャインフォーミー

スコア×ML比較表
予想理由（両モデルの観点から）
穴馬候補
懸念点
買い目提案
```

---

## ワークフロー

```
1. データ取得
   yarn fetch-and-extract <JRA URL>
   └─ HTML取得 → データ抽出 → JSON保存

2. DB登録
   yarn start import-url data/horse-extracted-data.json
   └─ 馬情報・血統・前走データを登録

3. 分析実行
   yarn start score     # スコアリング
   yarn start ml        # 機械学習予測

4. 最終予想
   └─ スコア × ML の両結果を総合判断
```

---

## 詳細ドキュメント

| ドキュメント | 内容 |
|-------------|------|
| [アーキテクチャ](docs/ARCHITECTURE.md) | システム構成図、シーケンス図、処理フロー |
| [コマンドリファレンス](docs/COMMANDS.md) | CLIコマンド・スキル完全リファレンス（19コマンド） |
| [データベース構造](docs/DATABASE.md) | テーブル定義、ER図、スキーマ詳細 |
| [分析モデル詳細](docs/MODELS.md) | スコアリング・機械学習モデルの詳細 |
| [開発者向け情報](docs/DEVELOPMENT.md) | 技術スタック、型定義、コーディング規約 |

---

## 注意事項

- 本システムは教育・研究目的で作成されています
- 実際の馬券購入は自己責任で行ってください
- スクレイピング機能はレート制限を設けていますが、JRA利用規約を遵守してください
- 予測結果の正確性は保証されません

---

## ライセンス

MIT License
